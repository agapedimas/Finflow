<ad-title><$ programs title /></ad-title>

<div class="header">
  <div class="buttons">
    <div></div>
    <button id="Button_NewProgram" class="icon">&#xf8dd;</button>
  </div>
  <div class="title"><$ programs title /></div>
</div>

<style>
    #Lists_Programs {
        display: grid;
        gap: 15px;
    }
        #Lists_Programs .program {
            display: grid;
            grid-template-areas:
                "date date"
                "name name"
                "x x"
                "total status";
            grid-auto-rows: max-content max-content 1em max-content;
            grid-auto-columns: auto;
            background-image: linear-gradient(0, var(--overlay-7) 100%);
            border-radius: 15px;
            padding: 17px;
            max-width: 600px;
            transition: 0.05s background-color;
        }
        #Lists_Programs .program:hover {
            background-color: var(--background-list-hover);
        }
        #Lists_Programs .program:active {
            background-color: var(--background-list-active);
        }
            #Lists_Programs .program .date {
                grid-area: date;
                font-weight: 500;
                font-size: 0.85em;
                letter-spacing: 0.05em;
            }
            #Lists_Programs .program .name {
                grid-area: name;
                font-size: 1.35em;
                font-weight: bold;
            }
            #Lists_Programs .program .total {
                grid-area: total;
                letter-spacing: 0.05em;
            }
            #Lists_Programs .program .status {
                grid-area: status;
                justify-self: self-end;
                letter-spacing: 0.05em;
                text-transform: uppercase;
                color: var(--foreground-description);
            }

    #Sheet_Program {
        background: var(--background-popover-grid);
    }
        #Sheet_Program .details {
            display: grid;
        }
            #Sheet_Program .details #Text_ProgramName {
                font-size: 1.45em;
                font-weight: bold;
            }
            #Sheet_Program .details .label,
            #Sheet_Program .joined .label {
                color: var(--foreground-description);
                font-size: 0.85em;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                margin-top: 1.25em;
            }
            #Sheet_Program .details span:not(.label) {
                font-weight: normal;
                letter-spacing: 0.015em;
            }
        #Sheet_Program .joined {
            display: grid;
        }
            #Sheet_Program .joined .avatar {
                width: 100%;
                border-radius: 100%;
                aspect-ratio: 1;
            }
            #Sheet_Program .joined #Button_AddStudent {
                color: var(--accent);
            }
                #Sheet_Program .joined #Button_AddStudent > div {
                    display: grid;
                    grid-auto-flow: column;
                    grid-auto-columns: 22px auto;
                    gap: 18px;
                }
                    #Sheet_Program .joined #Button_AddStudent > div .icon {
                        text-align: center;
                    }
        #Sheet_Program #Button_PayAll {
          border-radius: 10px;
          width: 100%;
          padding: 12px;
        }
    @media screen and not (max-width: 425px) {
        #Sheet_Program .details #Text_ProgramName {
            margin-right: calc(var(--padding) * 2);
        }
    }

  :where(#PopOver_AddStudent, #PopOver_AddProgram) {
  }
  :where(#PopOver_AddStudent, #PopOver_AddProgram) .stack {
    grid-auto-columns: 100px auto !important;
  }
  :where(#PopOver_AddStudent, #PopOver_AddProgram) .stack > span {
    font-weight: 600;
  }
  :where(#PopOver_AddStudent, #PopOver_AddProgram) .stack > label:has(select) {
    display: inline-grid;
    grid-auto-flow: column;
    justify-items: start;
    text-align: left !important;
    justify-content: space-between;
    opacity: 1;
  }
  :where(#PopOver_AddStudent, #PopOver_AddProgram) .stack :where(label:has(select:disabled), input:disabled) {
    opacity: 0.6 !important;
    pointer-events: none;
  }
</style>

<div class="content">
  <div class="cards" id="Lists_Programs"></div>
</div>

<div class="sheet" id="Sheet_Program">
  <div class="details">
    <span id="Text_ProgramName"></span>

    <span class="label"><$ programs period /></span>
    <span id="Text_ProgramDate"></span>

    <span class="label"><$ programs amount_total /></span>
    <span id="Text_ProgramAmountTotal"></span>

    <span class="label"><$ programs status /></span>
    <span id="Text_ProgramStatus"></span>
  </div>
  <div class="joined">
    <span class="label"><$ programs joined_students /></span>
    <div class="list" id="List_JoinedStudents">
      <div class="stack clickable" id="Button_AddStudent">
        <div>
          <span class="icon">&#xf8dd;</span>
          <span><$ programs invite_student /></span>
        </div>
      </div>
    </div>
  </div>
  <button id="Button_PayAll" class="plain accent">
    <span class="icon">&#xf7a3;</span>
    <span>
      <$ programs payall_title />
    </span>
  </button>
</div>

<div class="popover" id="PopOver_AddStudent">
  <div class="activity">
    <div class="header cascaded">
      <div class="buttons">
        <button id="Button_CancelAddStudent"><$ generic cancel /></button>
        <button id="Button_SubmitAddStudent">
          <div class="progressring"></div>
          <span><$ generic add /></span>
        </button>
      </div>
      <div class="title"><$ programs invite_student /></div>
    </div>
    <div class="content">
      <div class="list">
        <div class="stack email">
          <span><$ generic email /></span>
          <input id="Input_StudentEmail" type="email" class="plain" placeholder="<$ generic email_placeholder />" />
        </div>
      </div>
    </div>
  </div>
</div>

<div class="popover" id="PopOver_AddProgram">
  <div class="activity">
    <div class="header cascaded">
      <div class="buttons">
        <button id="Button_CancelAddProgram"><$ generic cancel /></button>
        <button id="Button_SubmitAddProgram">
          <div class="progressring"></div>
          <span><$ generic create /></span>
        </button>
      </div>
      <div class="title"><$ programs program_add_title /></div>
    </div>
    <div class="content">
      <div class="list">
        <div class="stack name">
          <span><$ programs input_name /></span>
          <input id="Input_ProgramName" type="text" class="plain" placeholder="<$ programs input_name_placeholder />" />
        </div>
        <div class="stack amount">
          <span><$ programs input_totalamount /></span>
          <input id="Input_ProgramAmount" type="text" class="plain" placeholder="<$ programs input_totalamount_placeholder />" />
        </div>
        <div class="stack startdate">
          <span><$ programs input_startdate /></span>
          <input id="Input_ProgramStartDate" type="date" class="plain" />
        </div>
        <div class="stack enddate">
          <span><$ programs input_enddate /></span>
          <input id="Input_ProgramEndDate" type="date" class="plain" />
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    Button_PayAll.onclick = async function() {
        // 1. Ambil Data Program saat ini
        const currentProgram = Sheet_Program.data;

        if (!currentProgram || !currentProgram.joinedStudents || currentProgram.joinedStudents.length === 0) {
            alert("Belum ada mahasiswa di program ini.");
            return;
        }

        // 2. Ambil ID Funding dari setiap mahasiswa
        // (Karena Anda sudah update backend, property .fundingId pasti ada)
        const fundingIds = currentProgram.joinedStudents
            .map(s => s.fundingId)
            .filter(id => id); // Hapus jika ada yang null

        if (fundingIds.length === 0) {
            alert("Data pembayaran tidak valid (ID Funding hilang).");
            return;
        }

        // 3. Konfirmasi Total Pembayaran
        // Kita hitung total manual atau pakai angka dari program
        const totalAmount = currentProgram.totalPeriodFund * fundingIds.length;
        const fmtTotal = formatCurrency(totalAmount);
        
        if (!confirm(`Konfirmasi Pembayaran:\n\nProgram: ${currentProgram.name}\nJumlah Mahasiswa: ${fundingIds.length}\nTotal Transfer: ${fmtTotal}\n\nLanjutkan?`)) {
            return;
        }

        // 4. Loading State
        const btn = this;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            // 5. Panggil API Confirm Transfer
            const res = await $.post("/api/funding/pay", { funding_ids: fundingIds });

            if (res.success) {
                const paidTotal = Number(res.data.total_paid).toLocaleString('id-ID');
                alert(`âœ… Pembayaran Sukses!\nTotal Terbayar: Rp ${paidTotal}\n\nStatus mahasiswa telah diperbarui menjadi 'Waiting Allocation'.`);
                
                // Tutup Sheet & Refresh List
                Sheet_Program.close();
                initializePrograms(); 

            } else {
                alert("Gagal: " + res.message);
            }

        } catch (error) {
            console.error(error);
            alert("Terjadi kesalahan koneksi server.");
        } finally {
            // Reset Tombol
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    registerCurrencyInput(Input_ProgramAmount);
    Button_NewProgram.onclick = function() {
        Input_ProgramName.value = null;
        Input_ProgramAmount.value = formatCurrency(0);
        Input_ProgramStartDate.value = null;
        Input_ProgramEndDate.value = null;
        PopOver_AddProgram.open(this);
        PopOver_AddProgram.onopened = function() {
            Input_ProgramName.focus();
        }
    }
    Button_CancelAddProgram.onclick = function() {
        PopOver_AddProgram.close(true);
    }
    Button_SubmitAddProgram.onclick = async function() {
        Input_ProgramName.disabled =
        Input_ProgramAmount.disabled =
        Input_ProgramStartDate.disabled =
        Input_ProgramEndDate.disabled =
        Button_CancelAddProgram.disabled = 
        Button_SubmitAddProgram.disabled =
        PopOver_AddProgram.isloading = true;
        PopOver_AddProgram.iscloseable = false;

    try {
      const payload = {
        program_name: Input_ProgramName.value,
        total_amount: Input_ProgramAmount.valueInt,
        start_date: Input_ProgramStartDate.value,
        end_date: Input_ProgramEndDate.value,
      };

      if (!payload.program_name || !payload.total_amount || !payload.start_date || !payload.end_date) {
        throw new Error("Mohon lengkapi semua data program.");
      }

      const res = await $.post("/api/program/create", payload);

      if (res.success) {
        // alert("Program Berhasil Dibuat!");
        PopOver_AddProgram.close(true);
        // [OPSIONAL] Refresh daftar program di halaman jika ada fungsi loadnya
        await initializePrograms();
      } else {
        // alert("Gagal: " + res.message);
      }

      PopOver_AddProgram.close(true);
    } catch (error) {
      console.error(error);
      const msg = error.responseJSON ? error.responseJSON.message : error.message;
      // alert("Terjadi kesalahan: " + msg);
    }

    Input_ProgramName.disabled = Input_ProgramAmount.disabled = Input_ProgramStartDate.disabled = Input_ProgramEndDate.disabled = Button_CancelAddProgram.disabled = Button_SubmitAddProgram.disabled = PopOver_AddProgram.isloading = false;
    PopOver_AddProgram.iscloseable = true;
  };
  Button_AddStudent.onclick = function () {
    Input_StudentEmail.value = null;
    PopOver_AddStudent.open(this);
    PopOver_AddStudent.onopened = function () {
      Input_StudentEmail.focus();
    };
  };
  Button_CancelAddStudent.onclick = function () {
    PopOver_AddStudent.close();
  };
  Button_SubmitAddStudent.onclick = async function () {
    Input_StudentEmail.disabled = Button_CancelAddStudent.disabled = Button_SubmitAddStudent.disabled = PopOver_AddStudent.isloading = true;
    PopOver_AddStudent.iscloseable = false;

    try {
      const email = Input_StudentEmail.value;
      const progId = PopOver_AddStudent.programId;

      if(!email) throw new Error("Email wajib diisi");
      if (!progId) throw new Error("ID Program hilang. Silahkan refresh.");

      const res = await $.post("/api/program/add-student", {
        program_id: progId,
        student_email: email
      });

      if (res.success) {
        // alert(`Berhasil! ${res.data.student_name} telah ditambahkan.`);
                
        // Opsional: Jika Anda ingin sheet detailnya tetap terbuka dan terupdate,
        // Anda perlu logika tambahan untuk mencari program yang tadi diedit 
        // dan membukanya kembali. Tapi reload list saja sudah cukup agar data sinkron.
                
        // Menutup sheet agar user bisa klik ulang untuk melihat data terbaru
        if(typeof Sheet_Program !== 'undefined') Sheet_Program.close();
      } else {
        console.error(res.message);
        // alert("Gagal: " + res.message);
      }
    } catch (error) {
        console.error(error);
        const msg = error.responseJSON ? error.responseJSON.message : error.message;
        // alert("Terjadi kesalahan: " + msg);
    }

    Input_StudentEmail.disabled = Button_CancelAddStudent.disabled = Button_SubmitAddStudent.disabled = PopOver_AddStudent.isloading = false;
    PopOver_AddStudent.iscloseable = true;
  };

  initializePrograms();

  async function initializePrograms() {
    try {
        const response = await $.get("/api/program/list");

        if (response.success && response.data) {
            Lists_Programs.innerHTML = null;
            for (const program of response.data) {
                appendProgram(program);
            }
        } else {
            console.log("Belum ada program yang dibuat.");
        }
    } catch (e) {
        console.error("Gagal memuat program:", e);
        // Jika error 401, redirect ke login
        if(e.status === 401) window.location.href = "/signin.html";
    }
  
    //const programs = DUMMY_PROGRAMS || $.get("/api/" + funderId + "/programs");

  }

  function appendProgram(program) {
    const nameElement = document.createElement("span");
    nameElement.classList.add("name");
    nameElement.innerText = program.name;

    const totalAmountElement = document.createElement("span");
    totalAmountElement.classList.add("total");
    totalAmountElement.innerText = formatCurrency(program.totalPeriodFund);

    const dateElement = document.createElement("span");
    dateElement.classList.add("date");
    dateElement.innerText = moment(program.startDate).format("ll") + " - " + moment(program.endDate).format("ll");

    const statusElement = document.createElement("span");
    statusElement.classList.add("status");
    statusElement.innerText = program.status;

    const programElement = document.createElement("div");
    programElement.classList.add("program");
    programElement.append(dateElement);
    programElement.append(nameElement);
    programElement.append(totalAmountElement);
    programElement.append(statusElement);
    programElement.onclick = function (event) {
      Text_ProgramName.innerText = nameElement.innerHTML;
      Text_ProgramDate.innerText = dateElement.innerHTML;
      Text_ProgramAmountTotal.innerText = totalAmountElement.innerHTML;
      Text_ProgramStatus.innerText = statusElement.innerHTML;

      for (const oldStudent of [...List_JoinedStudents.children]) {
        if (oldStudent.tagName == "DIV" && oldStudent.classList.contains("iconed"))
            oldStudent.remove();
      }
      
      for (const student of program.joinedStudents) appendStudents(student);

      if (typeof PopOver_AddStudent !== 'undefined') {
          PopOver_AddStudent.programId = program.programId; 
          console.log("Program Active:", program.programId); // Debug
      }

      Sheet_Program.data = program;
      Sheet_Program.open();

    };

    Lists_Programs.append(programElement);
  }

  function appendStudents(student) {
    const avatarElement = document.createElement("img");
    avatarElement.classList.add("avatar");
    avatarElement.src = "/avatar/" + student.id;

    const nameElement = document.createElement("span");
    nameElement.classList.add("name");
    nameElement.innerText = student.name;

    const stackElement = document.createElement("div");
    stackElement.classList.add("stack");
    stackElement.classList.add("iconed");
    stackElement.append(avatarElement);
    stackElement.append(nameElement);

    List_JoinedStudents.append(stackElement);
  }
</script>
