<ad-title><$ budgetplan title /></ad-title>


<style>
    html:not([theme=dark]) .root .main {
        background: var(--gray-6);
    }
    body, .root, .main,
    #Activity_Main {
        background: inherit;
    }

    #Header_MonthlyPlan {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: auto max-content;
        align-items: center;
        gap: 20px;
    }
        #Header_MonthlyPlan #Tab_Months {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: max-content;
            gap: 20px;
            overflow-x: auto;
            margin: 0 -20px 0 -30px;
            padding: 0 20px 0 30px;
            scrollbar-width: none;
            scroll-behavior: smooth;
        }
            #Header_MonthlyPlan #Tab_Months span {
                font-size: 1.1em;
                font-weight: 600;
                opacity: 0.5;
                transition: 0.075s opacity;
            }
            #Header_MonthlyPlan #Tab_Months span.active {
                opacity: 1;
            }
            #Header_MonthlyPlan #Tab_Months span:hover {
                opacity: 0.75;
            }
            #Header_MonthlyPlan #Tab_Months span:active {
                opacity: 0.35;
            }

    #Header_MonthlyPlan,
    #List_MonthlyPlan {
        max-width: 800px;
    }
        #List_MonthlyPlan .stack .thumbnail {
            width: 35px;
            height: 35px;
            border-radius: 100%;
            background: var(--overlay-8);
        }
        #List_MonthlyPlan .stack .description {
            display: grid;
            grid-auto-columns: max-content;
            grid-auto-rows: max-content;
        }
            #List_MonthlyPlan .stack .description .name {
            }
            #List_MonthlyPlan .stack .description .amount {
                color: var(--foreground-description);
            }
            #List_MonthlyPlan .stack .description .quantity {
                margin-left: 0.5ch;
                font-weight: 600;
            }
        #List_MonthlyPlan .stack .navigate {
            display: grid;
            grid-auto-flow: column;
            gap: 0.15em;
        }
            #List_MonthlyPlan .stack .navigate .amount {
                display: grid;
                grid-auto-flow: column;
                align-items: center;
                gap: 0.75ch;
            }
            #List_MonthlyPlan .stack .navigate .amount.income {
                color: #34c759;
            }
            [theme=dark]
            #List_MonthlyPlan .stack .navigate .amount.income {
                color: #30d158;
            }
            #List_MonthlyPlan .stack .navigate .amount.expenses {
                color: #ff3b30;
            }
            [theme=dark]
            #List_MonthlyPlan .stack .navigate .amount.expenses {
                color: #ff453a;
            }
                #List_MonthlyPlan .stack .navigate .amount.income::before {
                    content: "\eae9";
                    font-family: var(--font-icon);
                    font-size: 0.85em;
                }
                #List_MonthlyPlan .stack .navigate .amount.expenses::before {
                    content: "\eba9";
                    font-family: var(--font-icon);
                    font-size: 0.85em;
                }
            #List_MonthlyPlan .stack .navigate .icon {
                color: var(--foreground-description);
            }
    

    :where(#PopOver_NewPlan, #PopOver_EditPlan) {
    }
        :where(#PopOver_NewPlan, #PopOver_EditPlan) .stack {
            grid-auto-columns: 100px auto !important;
        }
            :where(#PopOver_NewPlan, #PopOver_EditPlan) .stack > span {
                font-weight: 600;
            }
            :where(#PopOver_NewPlan, #PopOver_EditPlan) .stack > label:has(select) {
                display: inline-grid;
                grid-auto-flow: column;
                justify-items: start;
                text-align: left !important;
                justify-content: space-between;
                opacity: 1;
            }
            :where(#PopOver_NewPlan, #PopOver_EditPlan) .stack :where(label:has(select:disabled), input:disabled) {
                opacity: 0.6 !important;
                pointer-events: none;
            }

    
    #List_PlanDetails .stack:not(.vertical) {
        grid-auto-columns: 100px auto;
    }
        #List_PlanDetails .stack.vertical > span:nth-child(2):not(:empty) {
            color: var(--foreground-description);
            margin-top: 0.25em;
        }
        #List_PlanDetails .stack:not(.vertical) > span:nth-child(2) {
            color: var(--foreground-description);
            text-align: right;
        }
</style>

<section>
    <div class="header">
        <div class="buttons">
            <div></div>
            <button id="Button_NewPlan" class="icon" ad-tooltip="<$ budgetplan newplan_title />">&#xf8dd;</button>
        </div>
        <div class="title"><$ budgetplan title /></div>
    </div>

    <div class="content">
        <div id="Header_MonthlyPlan" class="header">
            <div id="Tab_Months" class="tab">
                <span data-month="jan"><$ generic month_january_short /></span>
                <span data-month="feb"><$ generic month_february_short /></span>
                <span data-month="mar"><$ generic month_march_short /></span>
                <span data-month="apr"><$ generic month_april_short /></span>
                <span data-month="may"><$ generic month_may_short /></span>
                <span data-month="jun"><$ generic month_june_short /></span>
                <span data-month="jul"><$ generic month_july_short /></span>
                <span data-month="aug"><$ generic month_august_short /></span>
                <span data-month="sep"><$ generic month_september_short /></span>
                <span data-month="oct"><$ generic month_october_short /></span>
                <span data-month="nov"><$ generic month_november_short /></span>
                <span data-month="dec"><$ generic month_december_short /></span>
            </div>
            <select id="Select_Years"></select>
        </div>
        <div id="List_MonthlyPlan" class="cards">
        </div>
    </div>
</section>
<section>
    <div class="header">
        <div class="buttons">
            <button id="Button_EditPlan" ad-tooltip="<$ budgetplan editplan_title />"><$ generic edit /></button>
        </div>
        <div class="title"></div>
    </div>
    <div class="content">
        <div class="list" id="List_PlanDetails">
            <div class="stack name">
                <span><$ generic amount /></span>
                <span id="Text_StuffAmount"></span>
            </div>
            <div class="stack quantity">
                <span><$ generic quantity /></span>
                <span id="Text_StuffQuantity"></span>
            </div>
            <div class="stack category">
                <span><$ generic category /></span>
                <span id="Text_StuffCategory"></span>
            </div>
            <div class="stack status">
                <span><$ generic status /></span>
                <span id="Text_StuffStatus"></span>
            </div>
            <div class="stack feedback vertical">
                <span><$ generic ai_feedback /></span>
                <span id="Text_StuffFeedback"></span>
            </div>
        </div>
    </div>
</section>


<div class="popover" id="PopOver_NewPlan" preventDefault>
    <div class="activity">
        <div class="header cascaded">
            <div class="title"><$ budgetplan newplan_title /></div>
            <div class="buttons">
                <button id="Button_CancelNewPlan"><$ generic cancel /></button>
                <button id="Button_SubmitNewPlan">
                    <span><$ generic create /></span>
                    <div class="progressring"></div>
                </button>
            </div>
        </div>
        <div class="content">
            <div class="list">
                <div class="stack name">
                    <span><$ generic name /></span>
                    <input id="Input_StuffName" type="text" class="plain" placeholder="<$ generic name />"/>
                </div>
                <div class="stack amount">
                    <span><$ generic amount /></span>
                    <input id="Input_StuffAmount" type="text" class="plain" value="Rp0" placeholder="<$ generic amount_placeholder />"/>
                </div>
                <div class="stack quantity">
                    <span><$ generic quantity /></span>
                    <input id="Input_StuffQuantity" type="number" class="plain" value="1" min="1"/>
                </div>
                <div class="stack category">
                    <span><$ generic category /></span>
                    <select id="Select_StuffCategory" class="plain"></select>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="popover" id="PopOver_EditPlan" preventDefault>
    <div class="activity">
        <div class="header cascaded">
            <div class="title"><$ budgetplan editplan_title /></div>
            <div class="buttons">
                <button id="Button_CancelEditPlan"><$ generic cancel /></button>
                <button id="Button_SubmitEditPlan">
                    <span><$ generic done /></span>
                    <div class="progressring"></div>
                </button>
            </div>
        </div>
        <div class="content">
            <div class="list">
                <div class="stack name">
                    <span><$ generic name /></span>
                    <input id="Input_StuffNameEdit" type="text" class="plain" placeholder="<$ generic name />"/>
                </div>
                <div class="stack amount">
                    <span><$ generic amount /></span>
                    <input id="Input_StuffAmountEdit" type="text" class="plain" value="Rp0" placeholder="<$ generic amount_placeholder />"/>
                </div>
                <div class="stack quantity">
                    <span><$ generic quantity /></span>
                    <input id="Input_StuffQuantityEdit" type="number" class="plain" value="1" min="1"/>
                </div>
                <div class="stack category">
                    <span><$ generic category /></span>
                    <select id="Select_StuffCategoryEdit" class="plain"></select>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let categories = [];

    PopOver_NewPlan.onbeforeclose = function() {
        if (PopOver_NewPlan.isinputchanged == false)
            return PopOver_NewPlan.close(true);

        Components.ActionSheet.Open({
            Title: "<$ budgetplan newplan_discard_title />",
            Description: "<$ budgetplan newplan_discard_description />",
            Actions: [
                {
                    Type: "Option.Critical",
                    Title: "<$ budgetplan newplan_discard_confirm />",
                    Action: function() {
                        PopOver_NewPlan.close(true);
                    }
                },
                {
                    Type: "Footer",
                    Title: "<$ budgetplan newplan_discard_cancel />"
                }
            ]
        })
    }
    PopOver_EditPlan.onbeforeclose = function() {
        if (PopOver_EditPlan.isinputchanged == false)
            return PopOver_EditPlan.close(true);

        Components.ActionSheet.Open({
            Title: "<$ budgetplan editplan_discard_title />",
            Description: "<$ budgetplan editplan_discard_description />",
            Actions: [
                {
                    Type: "Option.Critical",
                    Title: "<$ budgetplan editplan_discard_confirm />",
                    Action: function() {
                        PopOver_EditPlan.close(true);
                    }
                },
                {
                    Type: "Footer",
                    Title: "<$ budgetplan editplan_discard_cancel />"
                }
            ]
        })
    }

    const newPlanInputs = [Input_StuffName, Input_StuffAmount, Input_StuffQuantity, Select_StuffCategory];
    const editPlanInputs = [Input_StuffNameEdit, Input_StuffAmountEdit, Input_StuffQuantityEdit, Select_StuffCategoryEdit];
    
    Button_NewPlan.onclick = function() {
        Input_StuffName.value = "";
        Input_StuffAmount.value = "Rp0";
        Input_StuffQuantity.value = 1;
        checkInputs(PopOver_NewPlan);
        PopOver_NewPlan.isinputchanged = false;
        PopOver_NewPlan.open(this);
    }
    Button_CancelNewPlan.onclick = function() {
        PopOver_NewPlan.close();
    }
    Button_SubmitNewPlan.onclick = async function() {
        Button_SubmitNewPlan.disabled =
        Button_CancelNewPlan.disabled = 
        PopOver_NewPlan.isloading = true;
        for (const input of newPlanInputs)
            input.disabled = true;

        const plan = {
            name: Input_StuffName.value,
            amount: parseInt(Input_StuffAmount.value.replace(/[^0-9]/g, "")) || 0,
            quantity: parseInt(Input_StuffQuantity.value) || 0,
            categoryId: Select_StuffCategory.value
        }

        try {
            // DUMMY ACTION
            await Delay(500);
            DUMMY_MONTHLY_PLAN.stuffs.push(plan);
            // await $.post("/api/budgetplan/", plan);
            const activeMonth = [...Tab_Months.children].find(o => o.classList.contains("active"))?.dataset?.month;
            const activeYear = Select_Years.value;
            fetchPlanList(activeMonth, activeYear);
        }
        catch (error) {
        }

        Button_SubmitNewPlan.disabled =
        Button_CancelNewPlan.disabled = 
        PopOver_NewPlan.isloading = false;
        for (const input of newPlanInputs)
            input.disabled = false;
        PopOver_NewPlan.close(true);

        console.log(plan);
    }
    Button_EditPlan.onclick = async function() {
        const plan = Activity_Main.sections[1].data;
        Input_StuffNameEdit.value = plan.name;
        Input_StuffAmountEdit.value = formatCurrency(plan.amount);
        Input_StuffQuantityEdit.value = plan.quantity;
        Select_StuffCategoryEdit.value = plan.categoryId;
        checkInputs(PopOver_EditPlan);
        PopOver_EditPlan.isinputchanged = false;
        PopOver_EditPlan.open();
    }
    Button_CancelEditPlan.onclick = function() {
        PopOver_EditPlan.close();
    }
    Button_SubmitEditPlan.onclick = async function() {
        Button_SubmitEditPlan.disabled =
        Button_CancelEditPlan.disabled = 
        PopOver_EditPlan.isloading = true;
        for (const input of editPlanInputs)
            input.disabled = true;

        const plan = {
            name: Input_StuffNameEdit.value,
            amount: parseInt(Input_StuffAmountEdit.value.replace(/[^0-9]/g, "")) || 0,
            quantity: parseInt(Input_StuffQuantityEdit.value) || 0,
            categoryId: Select_StuffCategoryEdit.value,
            status: "pending",
            feedback: null
        }

        Object.assign(Activity_Main.sections[1].data, plan);

        try {
            // DUMMY ACTION
            await Delay(500);
            // await $.patch("/api/budgetplan/", plan);
            
            const category = categories.find(o => o.id == plan.categoryId);
            Activity_Main.sections[1].name = plan.name;
            
            Text_StuffAmount.innerText = formatCurrency(plan.amount);
            Text_StuffQuantity.innerText = plan.quantity;
            Text_StuffCategory.innerText = category.name;
            Text_StuffStatus.innerText = "<$ budgetplan plan_status_pending />";

            Text_StuffStatus.setAttribute("class", "pending");
            Text_StuffFeedback.innerText = plan.feedback;

            const activeMonth = [...Tab_Months.children].find(o => o.classList.contains("active"))?.dataset?.month;
            const activeYear = Select_Years.value;
            fetchPlanList(activeMonth, activeYear);
        }
        catch (error) {
        }
        
        Button_SubmitEditPlan.disabled =
        Button_CancelEditPlan.disabled = 
        PopOver_EditPlan.isloading = false;
        for (const input of editPlanInputs)
            input.disabled = false;
        PopOver_EditPlan.close(true);
    }

    Input_StuffName.oninput = 
    Input_StuffQuantity.oninput =
    Select_StuffCategory.onchange =
    Input_StuffNameEdit.oninput = 
    Input_StuffQuantityEdit.oninput =
    Select_StuffCategoryEdit.onchange = function() {
        PopOver_NewPlan.isinputchanged = true;
        PopOver_EditPlan.isinputchanged = true;
        checkInputs(PopOver_EditPlan);
    }
    registerCurrencyInput(Input_StuffAmount);
    registerCurrencyInput(Input_StuffAmountEdit);
    Input_StuffAmount.oninput = 
    Input_StuffAmountEdit.oninput = function() {
        if (this != Input_StuffName)
            Input_StuffName.oninput();
        if (this != Input_StuffAmountEdit)
            Input_StuffAmountEdit.oninput();
    }
    Input_StuffAmount.onblur =
    Input_StuffAmountEdit.onblur = function() {
        checkInputs(PopOver_EditPlan);
    }

    function checkInputs(popOver = null) {
        let isSubmitEnabled = true;
        if (popOver == PopOver_NewPlan) {
            for (const input of newPlanInputs) {
                if (input.value.trim() == "") {
                    isSubmitEnabled = false;
                    break;
                }
            }
            Button_SubmitNewPlan.disabled = !isSubmitEnabled;
        }
        else {
            for (const input of editPlanInputs) {
                if (input.value.trim() == "") {
                    isSubmitEnabled = false;
                    break;
                }
            }
            Button_SubmitEditPlan.disabled = !isSubmitEnabled;
        }
        return isSubmitEnabled;
    }

    initializeCategories();
    initializePlanList();

    async function initializeCategories() {
        categories = DUMMY_CATEGORIES || await $.get("/api/categories");

        for (const category of categories) {
            const optionElement = document.createElement("option");
            optionElement.value = category.id;
            optionElement.innerText = category.name;
            Select_StuffCategory.append(optionElement);
            Select_StuffCategoryEdit.append(optionElement.cloneNode(true));
        }
    }

    function initializePlanList() {
        for (const tab of Tab_Months.children) {
            tab.onclick = function() {
                fetchPlanList(tab.dataset.month, Select_Years.value);
            }
        }
        
        const months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
        const currentMonth = months[new Date().getMonth()];
        const currentYear = new Date().getFullYear();
        fetchPlanList(currentMonth, currentYear);
        
        const years = DUMMY_YEARS || $.get("/client/cashflow/transactions/years");
        for (const year of years) {
            const optionElement = document.createElement("option");
            optionElement.value = year;
            optionElement.innerText = year;
            if (currentYear == year)
                optionElement.selected = true;
            Select_Years.append(optionElement);
        }
    }

    function fetchPlanList(month, year) {
        let activeTab;

        for (const tab of Tab_Months.children) {
            if (tab.dataset.month == month) {
                tab.classList.add("active");
                activeTab = tab;
            }
            else {
                tab.classList.remove("active");
            }
        }
            
        if (activeTab) {
            console.log(activeTab.nextElement)
            const x = activeTab.getBoundingClientRect().x;
            if (x < 20)
                Tab_Months.scrollLeft = activeTab.offsetLeft - 20;
            else if (x + activeTab.clientWidth > window.innerWidth - Select_Years.parentNode.clientWidth - 50)
                Tab_Months.scrollLeft = (activeTab.nextElementSibling || activeTab).offsetLeft - Select_Years.offsetLeft + activeTab.clientWidth + 30;
        }

        const plans = DUMMY_MONTHLY_PLAN.stuffs || $("/client/budgetplan/data/?month=" + month + "&year=" + year);
        
        List_MonthlyPlan.innerHTML = null;

        for (const plan of plans) {
            appendPlanList(plan);
        }
    }

    function appendPlanList(plan) {
        const thumbnailElement = document.createElement("img");
        thumbnailElement.classList.add("thumbnail");
        thumbnailElement.src = "/client/categories/thumbnail/" + plan.categoryId;
        thumbnailElement.onerror = function() {
            this.src = ".png";
            this.onerror = null;
        }

        const nameElement = document.createElement("span");
        nameElement.classList.add("name");
        nameElement.innerText = plan.name;

        const quantityElement = document.createElement("span");
        quantityElement.classList.add("quantity");
        quantityElement.innerText = "Ã— " + plan.quantity;

        const amountElement = document.createElement("span");
        amountElement.classList.add("amount");
        amountElement.innerText = formatCurrency(plan.amount);
        amountElement.append(quantityElement);

        const descriptionGroupElement = document.createElement("div");
        descriptionGroupElement.classList.add("description");
        descriptionGroupElement.append(nameElement);
        descriptionGroupElement.append(amountElement);

        const statusElement = document.createElement("span");
        statusElement.classList.add("status");
        statusElement.classList.add(plan.status);
        if (plan.status == "approved")
            statusElement.innerText = "<$ budgetplan plan_status_approved />";
        else if (plan.status == "rejected")
            statusElement.innerText = "<$ budgetplan plan_status_rejected />";
        else if (plan.status == "pending")
            statusElement.innerText = "<$ budgetplan plan_status_pending />";

        const chevronElement = document.createElement("span");
        chevronElement.classList.add("icon");
        chevronElement.innerText = "\uef4a";

        const navigateElement = document.createElement("div");
        navigateElement.classList.add("navigate");
        navigateElement.append(statusElement);
        navigateElement.append(chevronElement);

        const containerElement = document.createElement("div");
        containerElement.classList.add("stack");
        containerElement.classList.add("iconed");
        containerElement.classList.add("clickable");
        containerElement.append(thumbnailElement);
        containerElement.append(descriptionGroupElement);
        containerElement.append(navigateElement);
        containerElement.onclick = function() {
            Activity_Main.navigateTo(1);
            Activity_Main.sections[1].name = plan.name;
            Activity_Main.sections[1].data = plan;
            
            const category = categories.find(o => o.id == plan.categoryId);

            Text_StuffAmount.innerText = formatCurrency(plan.amount);
            Text_StuffQuantity.innerText = plan.quantity;
            Text_StuffCategory.innerText = category.name;

            if (plan.status == "approved")
                Text_StuffStatus.innerText = "<$ budgetplan plan_status_approved />";
            else if (plan.status == "rejected")
                Text_StuffStatus.innerText = "<$ budgetplan plan_status_rejected />";
            else if (plan.status == "pending")
                Text_StuffStatus.innerText = "<$ budgetplan plan_status_pending />";

            Text_StuffStatus.setAttribute("class", plan.status);
            Text_StuffFeedback.innerText = plan.feedback;
        }
        
        const categoryGroupElements = [...List_MonthlyPlan.children];
        let categoryGroupMatches = categoryGroupElements.find(o => o.dataset.category == plan.categoryId);

        if (categoryGroupMatches == null) {
            const category = categories.find(o => o.id == plan.categoryId);
            categoryGroupMatches = document.createElement("div");
            categoryGroupMatches.classList.add("list");
            categoryGroupMatches.dataset.category = plan.categoryId;
            categoryGroupMatches.setAttribute("ad-header", category.name);
            List_MonthlyPlan.append(categoryGroupMatches);
        }

        categoryGroupMatches.append(containerElement);
    }
</script>