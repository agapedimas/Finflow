<ad-title><$ home title /></ad-title>

<div class="header">
    <div class="title"><$ home title /></div>
    <div class="buttons">
        <div></div>
        <button id="Button_Notifications" class="icon" ad-tooltip="<$ notifications title />">&#xed31;</button>
    </div>
</div>

<style>
    #Cards_ProgramInfo {
        display: grid;
        background: var(--overlay-7);
        border-radius: 15px;
        padding: 17px;
        max-width: 600px;
    }
        #Cards_ProgramInfo > div {
            display: grid;
            grid-template-areas: 
                "subtitle subtitle img"
                "title title img"
                "description description img"
                "status status img";
            grid-auto-columns: auto auto max-content;
            grid-auto-rows: max-content;
        }
            #Cards_ProgramInfo > div .subtitle {
                grid-area: subtitle;
                color: var(--foreground-description);
                font-weight: 600;
                font-size: 0.85em;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            #Cards_ProgramInfo > div .title {
                grid-area: title;
                font-size: 1.15em;
                font-weight: bold;
            }
            #Cards_ProgramInfo > div #Text_ProgramCurrentlyJoined_Name {
                grid-area: title;
                font-size: 1.75em;
            }
            #Cards_ProgramInfo > div .description {
                grid-area: description;
                color: var(--foreground-description);    
                margin: 0.25em 0;
                align-self: end;
            }
            #Cards_ProgramInfo > div .status {
                grid-area: status;
                color: var(--foreground-description);    
                align-self: end;
            }
            #Cards_ProgramInfo > div button {
                grid-area: status;
                position: relative;
                border-radius: 30px;
                text-transform: uppercase;
                font-size: 0.85em;
                letter-spacing: 0.015em;
                font-weight: 500;
                overflow: hidden;
                margin-top: 0.5em;
                justify-self: right;
            }
                #Cards_ProgramInfo > div button::before {
                    content: "";
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: var(--accent);
                    opacity: 0.1;
                }
            #Cards_ProgramInfo > div img {
                grid-area: img;
                width: 100px;
                height: 100px;
                border-radius: 100%;
            }

    #Cards_Wallet {
        display: grid;
        background: var(--overlay-7);
        border-radius: 15px;
        padding: 17px;
        max-width: 600px;
    }
        #Cards_Wallet > .label {
            color: var(--foreground-description);
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        #Cards_Wallet > #Text_WalletBalance {
            font-weight: bold;
            font-size: 1.75em;
        }
        #Cards_Wallet > #Grid_WalletCategories {
            display: flex;
            flex-flow: wrap;
            grid-auto-flow: column;
            gap: 1.5em 2em;    
            margin-top: 1em;
            border-top: 1px solid var(--background-input);
            padding-top: 1em;
        }
            #Cards_Wallet > #Grid_WalletCategories .category {
                display: grid;
            }
                #Cards_Wallet > #Grid_WalletCategories .category > .name {    
                    color: var(--foreground-description);
                    letter-spacing: 0.025em;
                    font-weight: 500;
                }

    #Cards_Recommendations {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: 275px;
        gap: 10px;
        overflow: auto;
        margin: 0 -30px;
        padding: 0 30px;
        scrollbar-width: none;
    }
        #Cards_Recommendations .card {
            display: grid;
            grid-auto-rows: 275px max-content;
            background: var(--overlay-7);
            border-radius: 15px;
        }
            #Cards_Recommendations .card .description {
                display: grid;
                grid-auto-flow: column;
                grid-auto-columns: auto max-content;
                gap: 5px;
                padding: 12px 15px;
            }
                #Cards_Recommendations .card .description .text {
                }
                #Cards_Recommendations .card .description .cta {
                    position: relative;
                    border-radius: 30px;
                    text-transform: uppercase;
                    font-size: 0.85em;
                    letter-spacing: 0.015em;
                    font-weight: 500;
                    overflow: hidden;
                }
                    #Cards_Recommendations .card .description .cta::before {
                        content: "";
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: var(--accent);
                        opacity: 0.1;
                    }
    
    #List_Notifications {
    }
        #List_Notifications .stack {
            gap: 0.25em;
        }
            #List_Notifications .stack .title {
                display: grid;
                grid-auto-flow: column;
                grid-auto-columns: auto max-content;
                font-weight: 600;
                align-items: center;
            }
            #List_Notifications .stack.unread .title::after {
                content: "";
                display: block;
                width: 7px;
                height: 7px;
                border-radius: 100%;
                background: red;
            }
</style>

<div class="content">
    <section ad-header="<$ home program_title />">
        <div id="Cards_ProgramInfo" class="cards">
            <div id="Grid_ProgramNotJoined" class="hidden">
                <span class="title"><$ home program_status_notjoined_title /></span>
                <span class="description"><$ home program_status_notjoined_description /></span>
                <button class="plain"><$ home program_learnmore_link /></button>
            </div>
            <div id="Grid_ProgramCurrentlyJoined" class="hidden">
                <span class="subtitle"><$ home program_status_joined_title /></span>
                <span class="title" id="Text_ProgramCurrentlyJoined_Name"></span>
                <span class="status" id="Text_ProgramCurrentlyJoined_Status"></span>
                <img id="Image_ProgramCurrentlyJoined"/>
            </div>
        </div>
    </section>
    <section ad-header="<$ home wallet_title />">
        <div id="Cards_Wallet" class="cards">
            <span class="label"><$ generic balance /></span>
            <span id="Text_WalletBalance">&nbsp;</span>
            <div id="Grid_WalletCategories"></div>
        </div>
    </section>
    <section ad-header="<$ home recommendations_title />">
        <div id="Cards_Recommendations" class="cards"></div>
    </section>
</div>

<div class="popover" id="PopOver_Notifications">
    <div class="activity">
        <div class="header cascaded">
            <div class="buttons">
                <div></div>
                <button id="Button_DoneNotification"><$ generic done /></button>
            </div>
            <div class="title"><$ notifications title /></div>
        </div>
        <div class="content">
            <div id="List_Notifications" class="cards">

            </div>
        </div>
    </div>
</div>

<script>
    Button_Notifications.onclick = function() {
        PopOver_Notifications.open(this);
    }
    Button_DoneNotification.onclick = function() {
        PopOver_Notifications.close(this);
    }
    PopOver_Notifications.onbeforeopen = function() {
        if (PopOver_Notifications.initialized != true)
            initializeNotifications();
    }

    initializeNotifications();
    initializeProgramInfoCards();
    initializeWalletCards();
    initializeRecommendationCards();

    async function initializeNotifications() {
        PopOver_Notifications.initialized = true;

        const notifications = DUMMY_NOTIFICATIONS || $.get("/api/notifications/history");
        List_Notifications.innerHTML = null;
        for (const notification of notifications)
            appendNotification(notification);
    }

    function appendNotification(notification) {
        const titleElement = document.createElement("span");
        titleElement.classList.add("title");
        titleElement.innerText = notification.title;

        const messageElement = document.createElement("span");
        messageElement.classList.add("message");
        messageElement.innerText = notification.message;

        const containerElement = document.createElement("div");
        containerElement.classList.add("stack");
        containerElement.classList.add("vertical");
        containerElement.classList.add(notification.type);
        containerElement.append(titleElement);
        containerElement.append(messageElement);
        containerElement.data = notification;

        if (notification.isRead == false)
            containerElement.classList.add("unread");

        const currentTimestamp = new Date(notification.createdAt);
        const currentDate = currentTimestamp.getDate();
        const currentMonth = currentTimestamp.getMonth() + 1;
        const currentYear = currentTimestamp.getFullYear();

        const dateGroupElements = [...List_Notifications.children];
        let dateGroupMatches = dateGroupElements.find(o =>
            o.dataset.date == currentDate &&
            o.dataset.month == currentMonth &&
            o.dataset.year == currentYear
        );

        if (dateGroupMatches == null) {
            dateGroupMatches = document.createElement("div");
            dateGroupMatches.classList.add("list");
            dateGroupMatches.dataset.date = currentDate;
            dateGroupMatches.dataset.month = currentMonth;
            dateGroupMatches.dataset.year = currentYear;

            // today
            const diffTimestamp = Date.now() - notification.createdAt; 
            if (diffTimestamp < 1000 * 60 * 60 * 24)
                dateGroupMatches.setAttribute("ad-header", "<$ generic today />");
            // yesterday
            else if (diffTimestamp < 1000 * 60 * 60 * 24 * 2)
                dateGroupMatches.setAttribute("ad-header", "<$ generic yesterday />");
            // a long time ago
            else
                dateGroupMatches.setAttribute("ad-header", moment(notification.createdAt).format("ll"));
            List_Notifications.append(dateGroupMatches);
        }

        dateGroupMatches.append(containerElement);
    }

    async function initializeProgramInfoCards() {
        // fetch data from /api/currentprogram
        const program = DUMMY_CURRENTPROGRAM || await $.get("/api/currentprogram");
        
        if (program.isJoined == false) {
            Grid_ProgramNotJoined.classList.remove("hidden");
            Grid_ProgramCurrentlyJoined.remove();
        }
        else {
            Text_ProgramCurrentlyJoined_Name.innerText = program.displayName;
            Text_ProgramCurrentlyJoined_Status.innerText = "<$ home program_status_joined_description />".format(moment(program.activeUntil).format("ll"));
            Grid_ProgramCurrentlyJoined.classList.remove("hidden");
            Image_ProgramCurrentlyJoined.src = "/avatar/" + program.funderId;
            Grid_ProgramNotJoined.remove();
        }
    }

    async function initializeWalletCards() {
        // fetch data from /api/wallet
        const wallet = DUMMY_WALLET || await $.get("/api/wallet");

        Text_WalletBalance.innerText = formatCurrency(wallet.balance);

        for (const allocation of wallet.allocations) {
            const name = document.createElement("span");
            name.classList.add("name");
            name.innerText = allocation.categoryName;

            const balance = document.createElement("span");
            balance.classList.add("balance");
            balance.innerText = formatCurrency(allocation.balance);

            const container = document.createElement("div");
            container.classList.add("category");
            container.append(name);
            container.append(balance);

            Grid_WalletCategories.append(container);
        }
    }

    async function initializeRecommendationCards() {
        // fetch data from '/client/recommendations'
        const recommendations = DUMMY_RECOMMENDATIONS || await $.get("/client/recommendations");

        // create card for each recommendation
        for (const recommendation of recommendations) {
            const thumbnailElement = document.createElement("img");
            thumbnailElement.classList.add("thumbnail");
            thumbnailElement.src = "/recommendations/thumbnails/" + recommendation.id;
            thumbnailElement.onerror = function() {
                this.src = ".png";
                this.onerror = null;
            }
            
            const textElement = document.createElement("span");
            textElement.classList.add("text");
            textElement.innerText = recommendation.text;

            const ctaElement = document.createElement("button");
            ctaElement.classList.add("cta");
            ctaElement.classList.add("plain");
            ctaElement.innerText = recommendation.cta;
            ctaElement.setAttribute("goto", recommendation.url);

            const descriptionGroupElement = document.createElement("div");
            descriptionGroupElement.classList.add("description");
            descriptionGroupElement.append(textElement);
            descriptionGroupElement.append(ctaElement);

            const containerElement = document.createElement("card");
            containerElement.classList.add("card");
            containerElement.append(thumbnailElement);
            containerElement.append(descriptionGroupElement);

            // append to cards container
            Cards_Recommendations.append(containerElement);
        }
    }
</script>