<ad-title><$ signup title /></ad-title>

<div class="panel" theme="light" accent="blue">
    <img src="/assets/logo_text.png"/>
    <div class="title">Aktivasi Mahasiswa</div>
    <div class="subtitle">Lengkapi data penerima beasiswa</div>
    <div class="inputs">
        <input type="email" id="Input_Email" ad-text="Email Akun" name="email" readonly style="background-color: #f0f0f0; cursor: not-allowed;"/>

        <input type="text" id="Input_DisplayName" ad-text="Nama Lengkap" name="displayname"/>
        
        <input type="text" id="Input_Bank" ad-text="Nama Bank (cth: Mandiri)" />
        <input type="text" id="Input_Rek" ad-text="Nomor Rekening Pribadi" />
        
        <input type="password" id="Input_Password" ad-text="Buat PIN / Password Cadangan" />

        <span class="error" id="Text_ErrorSignUp" style="display:none; color:red; font-size:0.9em; text-align:center;"></span>

        <button class="accent" id="Button_SignUp">
            <div class="progressring"></div>
            <span>Aktifkan Akun</span>
        </button>
    </div>
</div>

<style>
    .root
    {
        background: linear-gradient(125deg, #0a84ff, #0067ce);
    }
    .panel
    {
        position: fixed;
        top: 50%;
        left: 50%;
        display: grid;
        grid-auto-flow: row;
        transform: translate(-50%, -50%);
        background: var(--gray-6);
        padding: 33px 30px;
        border-radius: 25px;
        border: 1px solid var(--overlay-6);
        gap: 0.3em;
        width: 350px;
        box-shadow: 0 5px 35px 0px rgba(0, 0, 0, 0.075);    
        max-height: calc(100vh - var(--padding));
        max-height: calc(100dvh - var(--padding));
        overflow: auto;
    }
        .panel img
        {
            height: 1.55em;
        }
        .panel .title
        {
            font-size: 1.75em;
            font-family: var(--font-bold);
            margin: 0.25em 0 0;
        }
        .panel .subtitle
        {
            font-size: 1.25em;
            margin: 0 0 25px;
        }
        .panel .inputs
        {
            display: grid;
            gap: 7px;
        }
            .panel .inputs input,
            .panel .inputs button
            {
                padding: 0.6em 0.8em;
                border-radius: 10px;
            }
            .panel .inputs .error input
            {
                border: 1px solid var(--notice)
            }
            .panel .inputs span.error 
            {
                display: none;
                grid-auto-flow: column;
                grid-auto-columns: max-content auto;
                gap: 0.5em;
                color: var(--notice);
                font-size: 0.8em;
            }
                .panel .inputs span:not(#Text_ErrorSignUp).error:before 
                {
                    content: "\f1aa";
                    font-family: var(--font-icon);
                }
            .panel .inputs #Text_ErrorSignUp.error
            {
                text-align: center;
                margin: 0.5em 0 0 0;
                font-size: 0.9em;
            }
            .panel .inputs button
            {
                margin: 25px 0 0;
            }
                .panel .inputs button .progressring
                {
                    width: 1em;
                    height: 1em;
                }
                .panel:not(.loading) .inputs button .progressring
                {
                    display: none;
                }
            .panel .inputs .offersignup
            {
                margin-top: 1em;
                justify-self: center;
            }
</style>
<script src="https://cdn.jsdelivr.net/npm/@web3auth/modal@9.4.0/dist/modal.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@web3auth/ethereum-provider@9.4.0/dist/ethereumProvider.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<script src="../sdk.js"></script>
<script>
    $(".titlebar").remove();
    $("nav").remove();
    $(".loading").hide();

    // 1. Ambil Token dari URL
    const urlParams = new URLSearchParams(window.location.search);
    const inviteToken = urlParams.get('token');

    // 2. Pre-fill & Cek Login
    window.onload = async () => {
        if (!inviteToken) {
            alert("Link tidak valid (Token hilang). Mohon minta link baru.");
            window.location.replace("/index.html"); // Kembali ke home
            return;
        }

        const user = await Finflow.init();
        if (!user) {
            // Redirect balik ke login dengan membawa token agar tidak hilang
            window.location.replace("/web3auth/index.html?type=student&token=" + inviteToken);
        } else {
            const emailField = document.getElementById("Input_Email");
            if(emailField) {
                emailField.value = user.email;
            
                emailField.dispatchEvent(new Event('input', { bubbles: true }));
                emailField.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
    };

    // 3. Handle Submit
    document.getElementById("Button_SignUp").onclick = async function() {
        $(".panel").addClass("loading");
        const btn = this;
        btn.disabled = true;
        $("#Text_ErrorSignUp").hide();

        try {
            const dataInput = {
                inviteToken: inviteToken, // Token wajib
                fullName: document.getElementById("Input_DisplayName").value,
                bankName: document.getElementById("Input_Bank").value,
                bankAccount: document.getElementById("Input_Rek").value,
                password: document.getElementById("Input_Password").value
            };

            // Panggil SDK
            const result = await Finflow.registerStudent(dataInput);

            $(".panel").removeClass("loading");
            btn.disabled = false;

            if (result.success) {
                alert("Akun Aktif! Selamat datang.");
                window.location.replace("/client");
            } else {
                $("#Text_ErrorSignUp").text(result.message).show();
            }

        } catch (error) {
            console.error(error);
            $(".panel").removeClass("loading");
            btn.disabled = false;
            $("#Text_ErrorSignUp").text("Terjadi kesalahan sistem.").show();
        }
    }
</script>