<script src="https://cdn.jsdelivr.net/npm/@web3auth/modal@9.4.0/dist/modal.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@web3auth/ethereum-provider@9.4.0/dist/ethereumProvider.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<script src="/sdk.js"></script>

<ad-title><$ signup title /></ad-title>

<div class="panel" theme="light" accent="blue">
    <img src="/assets/logo_text.png"/>
    <div class="title" id="Text_SignUpTitle"><$ signup title /></div>
    <div class="subtitle"><$ signup description /></div>
    <div class="inputs">
        <input type="email" id="Input_Email" ad-text="Email Terverifikasi" name="email" readonly style="background-color: #f0f0f0; cursor: not-allowed;"/>
        
        <input type="text" id="Input_PICName" ad-text="Nama Penanggung Jawab" name="picname"/>
        <input type="text" id="Input_DisplayName_ScholarshipFunder" ad-text="Nama Organisasi / Yayasan" name="displayname"/>

        <input type="text" id="Input_Bank" ad-text="Nama Bank (cth: BCA)" />
        <input type="text" id="Input_Rek" ad-text="Nomor Rekening Sumber" />

        <span class="error" id="Text_ErrorSignUp" style="display:none; color:red; font-size:0.9em; text-align:center;"></span>

        <button class="accent" id="Button_SignUp">
            <div class="progressring"></div>
            <span>Selesaikan Pendaftaran</span>
        </button>
    </div>
</div>

<style>
    .root
    {
        background: linear-gradient(125deg, #0a84ff, #0067ce);
    }
    .panel
    {
        position: fixed;
        top: 50%;
        left: 50%;
        display: grid;
        grid-auto-flow: row;
        transform: translate(-50%, -50%);
        background: var(--gray-6);
        padding: 33px 30px;
        border-radius: 25px;
        border: 1px solid var(--overlay-6);
        gap: 0.3em;
        width: 350px;
        box-shadow: 0 5px 35px 0px rgba(0, 0, 0, 0.075);    
        max-height: calc(100vh - var(--padding));
        max-height: calc(100dvh - var(--padding));
        overflow: auto;
    }
        .panel img
        {
            height: 1.55em;
        }
        .panel .title
        {
            font-size: 1.75em;
            font-family: var(--font-bold);
            margin: 0.25em 0 0;
        }
        .panel .subtitle
        {
            font-size: 1.25em;
            margin: 0 0 25px;
        }
        .panel .inputs
        {
            display: grid;
            gap: 7px;
        }
            .panel .inputs input,
            .panel .inputs button
            {
                padding: 0.6em 0.8em;
                border-radius: 10px;
            }
            .panel .inputs .error input
            {
                border: 1px solid var(--notice)
            }
            .panel .inputs span.error 
            {
                display: none;
                grid-auto-flow: column;
                grid-auto-columns: max-content auto;
                gap: 0.5em;
                color: var(--notice);
                font-size: 0.8em;
            }
                .panel .inputs span:not(#Text_ErrorSignUp).error:before 
                {
                    content: "\f1aa";
                    font-family: var(--font-icon);
                }
            .panel .inputs #Text_ErrorSignUp.error
            {
                text-align: center;
                margin: 0.5em 0 0 0;
                font-size: 0.9em;
            }
            .panel .inputs button
            {
                margin: 25px 0 0;
            }
                .panel .inputs button .progressring
                {
                    width: 1em;
                    height: 1em;
                }
                .panel:not(.loading) .inputs button .progressring
                {
                    display: none;
                }
            .panel .inputs .offersignup
            {
                margin-top: 1em;
                justify-self: center;
            }
</style>

<script>
    // Kode UI bawaan Anda
    $(".titlebar").remove();
    $("nav").remove();
    $(".loading").hide();

    // --- LOGIC PENGISI EMAIL OTOMATIS ---
    window.onload = async () => {
        console.log("‚è≥ Mengecek status login...");

        // 1. Tunggu SDK Inisialisasi
        const user = await Finflow.init();
        
        // 2. Debugging: Cek di Console Browser (F12) apakah data user ada?
        console.log("üë§ Data User dari SDK:", user);

        if (!user) {
            alert("Sesi habis. Silakan login ulang.");
            window.location.replace("/web3auth/index.html?type=scholarshipfunder");
        } else {
            // 3. ISI KOLOM EMAIL
            const emailInput = document.getElementById("Input_Email");
            
            if (emailInput) {
                // Isi nilainya
                emailInput.value = user.email;
                
                // (Opsional) Kadang library UI butuh trigger event biar teksnya 'nempel'
                emailInput.dispatchEvent(new Event('input'));
                emailInput.dispatchEvent(new Event('change'));
                
                console.log("‚úÖ Email berhasil diisi:", user.email);
            } else {
                console.error("‚ùå Error: Element dengan ID 'Input_Email' tidak ditemukan di HTML!");
            }
        }
    };

    // --- LOGIC TOMBOL SUBMIT ---
    document.getElementById("Button_SignUp").onclick = async function() {
        // UI Loading
        $(".panel").addClass("loading");
        const btn = this;
        btn.disabled = true;
        
        // Sembunyikan error lama
        $("#Text_ErrorSignUp").hide(); 

        try {
            // Validasi Manual Sederhana
            const fullName = document.getElementById("Input_PICName").value;
            const bankName = document.getElementById("Input_Bank").value;

            if (!fullName || !bankName) {
                throw new Error("Mohon lengkapi Nama dan Bank.");
            }

            const dataInput = {
                fullName: fullName, 
                orgName: document.getElementById("Input_DisplayName_ScholarshipFunder").value,
                bankName: bankName, 
                bankAccount: document.getElementById("Input_Rek").value
            };

            // Panggil SDK
            const result = await Finflow.registerFunder(dataInput);

            $(".panel").removeClass("loading");
            btn.disabled = false;

            if (result.success) {
                window.location.href = "/funder"; 
            } else {
                // Tampilkan pesan error di elemen error Anda
                $("#Text_ErrorSignUp").text(result.message).show();
            }

        } catch (error) {
            console.error(error);
            $(".panel").removeClass("loading");
            btn.disabled = false;
            $("#Text_ErrorSignUp").text(error.message).show();
        }
    }
</script>