<ad-title><$ signin title /></ad-title>

<style>
    .root
    {
        background: linear-gradient(125deg, #0a84ff, #0067ce);
    }
    .panel
    {
        position: fixed;
        top: 50%;
        left: 50%;
        display: grid;
        grid-auto-flow: row;
        transform: translate(-50%, -50%);
        background: var(--gray-6);
        padding: 33px 30px;
        border-radius: 25px;
        border: 1px solid var(--overlay-6);
        gap: 0.3em;
        width: 350px;
        box-shadow: 0 5px 35px 0px rgba(0, 0, 0, 0.075);
    }
        .panel img
        {
            height: 1.55em;
        }
        .panel .title
        {
            font-size: 1.75em;
            font-family: var(--font-bold);
            margin: 0.25em 0 0;
        }
        .panel .subtitle
        {
            font-size: 1.25em;
            margin: 0 0 25px;
        }
        .panel .inputs
        {
            display: grid;
            gap: 7px;
        }
            .panel .inputs input,
            .panel .inputs button
            {
                padding: 0.6em 0.8em;
                border-radius: 10px;
            }
            .panel .inputs .error 
            {
                display: none;
                color: var(--notice);
                text-align: center;
                margin: 0.5em 0 0 0;
                font-size: 0.9em;
            }
            .panel .inputs button
            {
            }
                .panel .inputs button .progressring
                {
                    width: 1em;
                    height: 1em;
                }
                .panel:not(.loading) .inputs button .progressring
                {
                    display: none;
                }
            .panel .inputs .offersignup 
            {
                margin-top: 1em;
                justify-self: center;
            }
</style>

<script>
    $(".titlebar").remove();
    $("nav").remove();
    $(".loading").hide();
</script>

<div class="panel" theme="light" accent="blue">
    <img src="/assets/logo_text.png"/>
    <div class="title"><$ signin title /></div>
    <div class="subtitle"><$ signin description /></div>
    <div class="inputs">
        <button id="Button_SignIn" disabled>
            <div class="progressring"></div>
            <img class="icon" src="/assets/logo_google.webp" />
            <span><$ signin signin_with_google /></span>
        </button>
        <span class="error" id="Text_Error" style="display:none;"></span>
        <div class="offersignup">
            <span><$ signin offer_signup_title /></span>
            <a class="link" id="Button_SignUp" goto="/signup">
                <span><$ signin offer_signup_link /></span>
            </a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@web3auth/modal@9.4.0/dist/modal.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@web3auth/ethereum-provider@9.4.0/dist/ethereumProvider.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script src="/sdk.js"></script>

<script>
    // 1. Cek Status Login Saat Load
    window.onload = async () => {
        try {
            // Init SDK
            const user = await Finflow.init();
            Button_SignIn.disabled = false;
            
            if (user) {
                console.log("User detected, verifying session...");
                // Jika user refresh tapi masih login di Web3Auth, kita coba login ulang ke backend
                // untuk memastikan role dan session cookie aktif
                // handleBackendLogin();
                const btn = document.getElementById("Button_SignIn");
                if(btn) btn.querySelector("span").innerText = "Lanjutkan sebagai " + user.email;
            }
        } catch (e) {
            console.error("Init Error:", e);
        }
    };

    // 2. Handle Tombol Klik
    const btnSignIn = document.getElementById("Button_SignIn");
    
    btnSignIn.onclick = async function() {
        // Efek Loading (Sesuai style asli)
        $(".panel").addClass("loading");
        $("#Text_Error").hide();
        btnSignIn.disabled = true;

        try {
            // Panggil Login SDK (Popup Google)
            // Fungsi ini otomatis memanggil backend /auth/login juga
            const result = await Finflow.login();
            
            handleLoginSuccess(result);

        } catch (error) {
            console.error(error);
            showError(error.message || "Login dibatalkan atau gagal.");
        }
    };

    // Helper: Memanggil Backend Login tanpa popup (untuk auto-login)
    async function handleBackendLogin() {
        try {
            const result = await Finflow.backendLogin();
            handleLoginSuccess(result);
        } catch (e) {
            // Jangan show error kalau auto-login gagal, biarkan user klik tombol manual
            console.log("Auto-login failed, user must click button.");
        }
    }

    // Helper: Redirect sesuai Role
    function handleLoginSuccess(result) {
        // Reset Loading
        $(".panel").removeClass("loading");
        btnSignIn.disabled = false;

        if (result && result.success) {
            const role = result.data.role;
            
            if (role === 'student') {
                window.location.href = "/client";
            } else if (role === 'funder') {
                window.location.href = "/funder";
            } else {
                // Fallback
                window.location.href = "/client";
            }
        } else {
            // User login Google sukses, tapi belum daftar di Finflow
            window.location.href = "/signup";
        }
    }

    function showError(msg) {
        $(".panel").removeClass("loading");
        btnSignIn.disabled = false;
        
        const errEl = document.getElementById("Text_Error");
        if(errEl) {
            errEl.innerText = msg;
            errEl.style.display = "block";
        } else {
            alert(msg);
        }
    }
</script>